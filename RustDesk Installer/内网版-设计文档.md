# RustDesk 内网中继服务器 Docker 部署脚本设计文档（简化版）

## 1. 概述

本文档描述一个用于一键安装和配置 RustDesk 内网中继服务器的 Docker 部署脚本的设计方案。该脚本专注于内网使用场景，简化了功能集，仅保留必要的中继服务器功能，并使用 dialog 提供文本图形化界面。

## 2. 设计目标

- **专注内网部署**：仅支持内网使用场景的中继服务器功能
- **简化配置**：移除证书申请等非必要功能
- **交互友好**：使用 dialog 提供文本图形化界面
- **快速部署**：最小化配置选项，实现快速部署
- **资源高效**：优化容器配置，减少资源占用
- **易于维护**：使用 Docker 容器化，易于管理和升级
- **镜像加速**：使用国内镜像加速服务

## 3. 系统架构

### 3.1 组件设计（简化版）

```
+---------------------+
|  Dialog TUI界面      |
|  - 参数收集         |
|  - 进度显示         |
+----------+----------+
           |
           v
+---------------------+
|  配置验证模块        |
|  - 端口检查         |
|  - 参数验证         |
+----------+----------+
           |
           v
+---------------------+
|  Docker部署模块      |
|  - 镜像拉取         |
|  - 容器启动         |
+----------+----------+
           |
           v
+---------------------+
|  结果输出模块        |
|  - 部署结果         |
|  - 使用说明         |
+---------------------+
```

## 4. 功能设计

### 4.1 用户交互设计

#### 4.1.1 Dialog TUI 界面流程

1. **欢迎界面**：
   ```text
   ┌──────────────────────────────────────┐
   │ RustDesk 内网中继服务器安装程序       │
   │                                      │
   │ 本脚本将帮助您快速部署内网专用的      │
   │ RustDesk 中继服务器                  │
   │                                      │
   │            [ 确定 ]                  │
   └──────────────────────────────────────┘
   ```

2. **基础配置**：
   ```text
   ┌──────────────────────────────────────┐
   │ 请输入基础配置                        │
   │                                      │
   │ 服务器IP地址: [192.168.1.100 ]       │
   │                                      │
   │ 中继服务器端口: [21117    ]          │
   │                                      │
   │            [ 确定 ]  [ 取消 ]         │
   └──────────────────────────────────────┘
   ```

3. **高级配置（可选）**：
   ```text
   ┌──────────────────────────────────────┐
   │ 高级配置                              │
   │                                      │
   │ [ ] 限制带宽 (默认: 无限制)          │
   │     [ 最大带宽: 10    ] Mbps         │
   │                                      │
   │ [ ] 数据持久化 (默认: 不启用)        │
   │     [ 存储路径: /var/rustdesk ]      │
   │                                      │
   │            [ 确定 ]  [ 返回 ]         │
   └──────────────────────────────────────┘
   ```

4. **确认安装**：
   ```text
   ┌──────────────────────────────────────┐
   │ 确认安装配置                          │
   │                                      │
   │ 服务器IP: 192.168.1.100              │
   │ 中继端口: 21117                      │
   │ 带宽限制: 无限制                     │
   │ 数据持久化: 不启用                   │
   │                                      │
   │            [ 安装 ]  [ 返回 ]         │
   └──────────────────────────────────────┘
   ```

#### 4.1.2 配置参数（简化版）

- **必选参数**：
  - 服务器IP地址（自动检测默认值）
  - 中继服务器端口（默认21117）

- **可选参数**：
  - 带宽限制（Mbps）
  - 数据持久化路径

### 4.2 Docker 部署设计（简化版）

#### 4.2.1 最小化 docker-compose.yml

```yaml
version: '3'

services:
  hbbr:
    image: rustdesk/rustdesk-server:hbbr
    container_name: rustdesk-hbbr
    ports:
      - "${RELAY_PORT}:21117"
    volumes:
      - "${DATA_DIR}:/root"
    environment:
      - "LIMIT_SPEED=${LIMIT_SPEED}"
    restart: unless-stopped
    network_mode: "host"
```

#### 4.2.2 环境变量文件 (.env)

```bash
# 基础配置
RELAY_IP=192.168.1.100
RELAY_PORT=21117

# 高级配置
LIMIT_SPEED=0  # 0表示无限制
DATA_DIR=/tmp/rustdesk-data
```

### 4.3 安全设计（简化版）

- **内网专用安全措施**：
  - 使用 host 网络模式简化配置
  - 不暴露非必要端口
  - 默认不启用持久化存储（减少攻击面）

- **防火墙建议**：
  ```text
  [防火墙建议]
  只需开放您选择的中继端口(默认21117)即可
  示例命令:
    sudo ufw allow 21117/tcp
  ```

## 5. 部署流程

1. 检查 Docker 环境
2. 通过 dialog 收集配置
3. 生成 docker-compose.yml 和 .env 文件
4. 启动 Docker 容器
5. 验证服务运行状态
6. 输出部署结果和使用说明

## 6. 输出设计（简化版）

- **部署成功界面**：
  ```text
  ┌──────────────────────────────────────┐
  │ 部署成功                             │
  │                                      │
  │ RustDesk 中继服务器已成功启动        │
  │                                      │
  │ 服务器地址: 192.168.1.100:21117      │
  │                                      │
  │ 客户端配置:                          │
  │ 在RustDesk客户端设置->网络->         │
  │ 中继服务器中输入上述地址             │
  │                                      │
  │            [ 完成 ]                  │
  └──────────────────────────────────────┘
  ```

- **日志文件**：
  - 简化为 `/tmp/rustdesk-install.log`

## 7. 异常处理（简化版）

- **主要错误检测**：
  - Docker 服务未运行
  - 端口冲突
  - 镜像拉取失败

- **错误恢复**：
  - 提供清除已创建资源的选项
  - 显示简明错误信息和建议

## 8. 附录

### 8.1 最小化依赖列表

- Docker 20.10+
- docker-compose 1.28+
- dialog 1.3+

### 8.2 示例脚本结构

```bash
#!/bin/bash

# 配置默认值
DEFAULT_IP=$(hostname -I | awk '{print $1}')
DEFAULT_PORT=21117
DATA_DIR="/tmp/rustdesk-data"

# 检查依赖
check_dependencies() {
    # 检查docker, docker-compose, dialog是否安装
    # 如果缺少则提示安装
}

# 显示欢迎界面
show_welcome() {
    dialog --title "RustDesk 内网中继服务器安装" \
           --msgbox "本脚本将帮助您快速部署内网专用的RustDesk中继服务器" 10 50
}

# 收集基础配置
collect_basic_config() {
    # 使用dialog表单收集IP和端口
}

# 部署服务
deploy_service() {
    # 生成.env文件
    # 启动docker容器
    # 检查运行状态
}

# 主流程
main() {
    check_dependencies
    show_welcome
    collect_basic_config
    deploy_service
    show_result
}

main
```

### 8.3 卸载功能

```text
┌──────────────────────────────────────┐
│ 卸载 RustDesk 中继服务器             │
│                                      │
│ 这将停止并删除中继服务器容器         │
│                                      │
│ 注意: 持久化数据需要手动删除          │
│                                      │
│            [ 卸载 ]  [ 取消 ]         │
└──────────────────────────────────────┘
```